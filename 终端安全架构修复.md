# 终端安全架构修复

## 问题
之前的实现错误地将服务器密码发送到前端，这是一个严重的安全漏洞。

## 正确的架构

```
前端（浏览器）
    ↓ WebSocket: 只发送服务器名称
部署平台
    ├─ 从 hosts.json 读取完整配置（包括密码）
    └─ SSH连接到目标服务器
        ↓
目标服务器
```

## 修复内容

### 数据流向

**修复前（错误）：**
```javascript
前端 → 发送 {name, host, port, password} → 后端
              ❌ 密码暴露给前端
```

**修复后（正确）：**
```javascript
前端 → 发送 {name, cols, rows} → 后端
后端 → 从 hosts.json 读取密码 → SSH连接
              ✅ 密码只存在于服务器
```

### 代码变更

#### 1. 前端 Terminal.vue
```javascript
// 只发送服务器名称和终端尺寸
data: {
  name: this.hostInfo.name,  // 只发送名称
  cols: this.terminal.cols,
  rows: this.terminal.rows,
}
```

#### 2. 前端 Hosts.vue
```javascript
openTerminal(item) {
  // 只传递服务器名称，不传密码
  this.$refs.terminalRef.open({
    name: item.name,
    host: item.host,  // 仅用于显示
    port: item.port   // 仅用于显示
  });
}
```

#### 3. 后端 ws.js
```javascript
async handleConnect(sessionId, websocket, data, ctx) {
  // 从hosts.json读取完整配置
  const hostConfig = await ctx.service.terminal.getHostConfig(
    data.name,
    ctx.request.headers.env
  );
  
  // hostConfig 包含: {name, host, password, port}
}
```

#### 4. 后端 terminal.js
```javascript
// 新增方法：从hosts.json读取配置
async getHostConfig(name, env) {
  const hostsFile = path.resolve(workspaceDir, env, "hosts.json");
  const data = await readFile(hostsFile, "utf-8");
  const jsonData = JSON.parse(data);
  
  const [host, password, port = 22] = jsonData[name].split(":");
  
  return { name, host, password, port };
}
```

### 删除的内容

- ❌ 后端 `getHostDetail` API（不再需要）
- ❌ 后端路由 `/deploy/host-detail`
- ❌ 前端 `fetchHostDetail` API调用
- ❌ 前端发送密码到WebSocket

## 安全优势

1. ✅ **密码不离开服务器**：密码只存在于部署平台的 `hosts.json` 文件中
2. ✅ **前端无法获取密码**：前端只知道服务器名称
3. ✅ **网络传输安全**：WebSocket中不再传输敏感密码
4. ✅ **符合安全最佳实践**：凭证集中管理在服务器端

## 工作流程

1. 用户点击"终端"按钮
2. 前端发送: `{type: "connect", data: {name: "server1"}}`
3. 后端接收名称后：
   - 读取 `workspace/环境/hosts.json`
   - 解析 `"server1": "192.168.1.1:password123:22"`
   - 使用完整信息建立SSH连接
4. 密码全程不出现在前端

## 验证方法

打开浏览器开发者工具 → Network → WS：
- ✅ 应该只看到 `{name: "xxx"}` 
- ❌ 不应该看到 `password` 字段
