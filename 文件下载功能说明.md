# 文件下载功能实现说明

## 功能概述
在 Files.vue 中新增了两种文件下载方式：
1. **从部署平台指定路径下载**：输入 `/usr/deployer-tmp` 目录下的文件路径进行下载
2. **从文件列表直接下载**：点击列表中的"下载"按钮直接下载当前环境的文件

## 安全限制
- ✅ 通过路径输入下载时，**只允许**下载 `/usr/deployer-tmp` 目录下的文件
- ✅ 前端和后端双重验证，防止路径遍历攻击
- ✅ 从文件列表下载时，自动使用当前环境的 files 目录，无需额外权限控制

## 实现细节

### 前端修改

#### 1. Files.vue UI增强
- 新增下载输入面板（灰色背景区域）
- 文件列表操作列增加"下载"按钮
- 操作列宽度从 120 调整为 180

#### 2. 下载方法
```javascript
// 从输入框路径下载
downloadFile() {
  // 验证路径必须以 /usr/deployer-tmp/ 开头
  APIDownloadFile(normalizedPath)
}

// 从列表下载
downloadFileFromList(item) {
  // 直接使用文件名，后端自动定位到环境目录
  APIDownloadFile(fileName, true)
}
```

#### 3. API封装 (files.js)
```javascript
export function APIDownloadFile(filePath, isFromList = false)
```
- 支持两种下载模式：路径下载和列表下载
- 自动处理文件名提取（从 Content-Disposition 或路径）
- 使用 Blob 和临时 URL 触发浏览器下载

### 后端实现

#### 1. 控制器方法 (deploy.js)
```javascript
async downloadFile(ctx) {
  const { filePath, fileName, fromList } = req.query;
  
  if (fromList) {
    // 从当前环境files目录下载
    targetFilePath = path.resolve(req.context.fileDir, fileName);
  } else {
    // 从指定路径下载（安全检查）
    if (!normalizedPath.startsWith('/usr/deployer-tmp/')) {
      return 403; // 禁止访问
    }
    targetFilePath = normalizedPath;
  }
  
  // 返回文件流
  ctx.body = fs.createReadStream(targetFilePath);
}
```

#### 2. 路由配置 (router.js)
```javascript
router.get("/deploy/download-file", auth, deployMiddle, controller.deploy.downloadFile);
```

## 使用方法

### 方式一：从部署平台路径下载
1. 在"下载文件"输入框中输入完整路径
2. 路径必须以 `/usr/deployer-tmp/` 开头
3. 点击"下载"按钮
4. 浏览器自动下载文件

**示例路径：**
```
/usr/deployer-tmp/backup.tar.gz
/usr/deployer-tmp/logs/app.log
/usr/deployer-tmp/temp/data.json
```

### 方式二：从文件列表下载
1. 在文件列表中找到目标文件
2. 点击该行的"下载"按钮
3. 浏览器自动下载文件

## 安全特性

### 路径验证
```javascript
// 前端验证
if (!normalizedPath.startsWith('/usr/deployer-tmp/')) {
  return ElMessage.error("只能下载 /usr/deployer-tmp 目录下的文件");
}

// 后端验证
const normalizedPath = path.normalize(filePath);
if (!normalizedPath.startsWith('/usr/deployer-tmp/')) {
  ctx.status = 403;
  return;
}
```

### 防护措施
- ✅ 路径规范化处理（防止 `../` 绕过）
- ✅ 白名单目录限制
- ✅ 文件存在性检查
- ✅ 前后端双重验证

## 错误处理

### 前端提示
- 空路径：提示输入文件路径
- 非法路径：提示只能下载指定目录文件
- 下载失败：显示具体错误信息

### 后端响应
- 400：缺少必要参数
- 403：路径不在允许范围
- 404：文件不存在
- 500：服务器内部错误

## 注意事项

1. **目录权限**：确保部署平台对 `/usr/deployer-tmp` 目录有读取权限
2. **大文件下载**：使用流式传输，不会占用大量内存
3. **文件名编码**：自动处理中文文件名的 URL 编码
4. **临时文件**：下载完成后自动清理浏览器临时 Blob URL

## 扩展建议

1. **下载进度**：为大文件添加下载进度显示
2. **批量下载**：支持选择多个文件打包下载
3. **权限细化**：根据用户角色限制可下载的文件类型
4. **日志记录**：记录文件下载操作以供审计
5. **目录浏览**：添加 `/usr/deployer-tmp` 目录的文件浏览功能
