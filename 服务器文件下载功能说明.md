# 服务器文件下载功能实现

## 功能概述
在服务器管理页面新增"下载"按钮，点击后打开文件浏览器，可以浏览远程服务器的文件系统并下载文件到本地。

## 实现架构

```
用户浏览器
    ↓
文件浏览器对话框
    ↓ WebSocket/HTTP
部署平台
    ↓ SSH + SFTP
远程服务器文件系统
    ↓ 文件流
用户本地下载
```

## 功能特点

1. **路径输入框**：手动输入路径并按回车或点击刷新按钮
2. **文件列表**：显示当前目录下的文件和文件夹
3. **文件夹导航**：点击文件夹进入子目录
4. **文件下载**：点击文件的"下载"按钮下载到本地
5. **上级目录**：显示".."项可返回上级目录
6. **文件信息**：显示文件大小、权限等信息

## 代码结构

### 前端

#### 1. RemoteFileBrowser.vue（文件浏览器组件）
```vue
<template>
  - 路径输入框（支持回车）
  - 文件列表表格
    - 文件/文件夹图标
    - 名称、大小、权限
    - 下载按钮（仅文件）
</template>
```

**功能方法：**
- `open(hostInfo)`: 打开对话框
- `loadPath()`: 加载指定路径的文件列表
- `handleRowClick(row)`: 点击行处理（文件夹则进入）
- `downloadFile(file)`: 下载文件

#### 2. Hosts.vue（服务器管理）
新增"下载"按钮，点击打开 RemoteFileBrowser

#### 3. API (remote.js)
- `fetchRemoteFiles(serverName, path)`: 获取远程文件列表
- `downloadRemoteFile(serverName, filePath, fileName)`: 下载远程文件

### 后端

#### 1. RemoteService（远程服务）
**方法：**
- `getHostConfig()`: 获取主机配置
- `createSSHConnection()`: 创建SSH连接
- `executeCommand()`: 执行SSH命令
- `listFiles()`: 列出目录文件（使用`ls -lAh`）
- `downloadFile()`: 下载文件（使用SFTP）

#### 2. DeployController
**新增API：**
- `GET /deploy/remote-files`: 获取远程文件列表
- `GET /deploy/remote-download`: 下载远程文件

## 使用流程

### 浏览文件
1. 点击服务器列表中的"下载"按钮
2. 弹出文件浏览器，默认显示根目录 `/`
3. 在路径输入框输入路径（如 `/home/user`）并回车
4. 或点击文件夹行进入该目录

### 下载文件
1. 在文件列表中找到目标文件
2. 点击该文件行的"下载"按钮
3. 浏览器自动下载文件到本地

### 返回上级目录
点击 `..` 项返回上级目录

## 技术实现

### 文件列表获取
使用 `ls -lAh` 命令：
```bash
ls -lAh --time-style='+%Y-%m-%d %H:%M:%S' "/path/to/dir"
```

输出格式：
```
drwxr-xr-x 2 root root 4.0K 2024-01-01 12:00:00 dirname
-rw-r--r-- 1 root root  1.5M 2024-01-01 12:00:00 filename.txt
```

解析规则：
- 第1列：权限（d开头为目录）
- 第5列：文件大小
- 第9列起：文件名

### 文件下载流程
1. 前端请求下载
2. 后端SSH连接到目标服务器
3. 使用SFTP创建读取流
4. 通过PassThrough流传递给HTTP响应
5. 前端接收blob并触发下载

### 安全机制
1. **认证保护**：所有API需要auth中间件验证
2. **环境隔离**：通过env header区分不同环境
3. **密码安全**：密码存储在服务器，不暴露给前端
4. **连接超时**：SSH连接15秒超时保护

## 删除的旧功能

已删除以下功能：
- ❌ Files.vue 中的 `/usr/deployer-tmp` 下载输入框
- ❌ 文件列表中的"下载"按钮
- ❌ `downloadFile()` 方法（限制下载路径的）
- ❌ 后端 `downloadFile` 控制器（/deploy/download-file）
- ❌ 前端 `APIDownloadFile` 方法

## 界面示例

```
┌─────────────────────────────────────────┐
│ 文件浏览器 - server1 (192.168.1.1)      │
├─────────────────────────────────────────┤
│ 📁 /home/user                [刷新]     │
├─────────────────────────────────────────┤
│ 名称          │ 大小  │ 权限         │操作│
├─────────────────────────────────────────┤
│ 📁 ..         │ -     │ drwxr-xr-x  │    │
│ 📁 documents  │ -     │ drwxr-xr-x  │    │
│ 📄 file.txt   │ 1.5M  │ -rw-r--r--  │下载│
│ 📄 data.json  │ 523K  │ -rw-r--r--  │下载│
└─────────────────────────────────────────┘
```

## 扩展建议

1. **多文件下载**：支持勾选多个文件打包下载
2. **文件上传**：支持从本地上传文件到远程服务器
3. **文件操作**：支持删除、重命名、移动文件
4. **搜索功能**：在当前目录搜索文件
5. **书签功能**：保存常用路径
6. **文件预览**：支持文本文件在线预览
7. **权限管理**：支持修改文件权限
8. **用户配置**：支持配置每个服务器的默认用户名
